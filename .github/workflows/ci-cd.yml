name: Django CI/CD with Docker Compose

on:
  push:
    branches: [main, dev/*]
  pull_request:
    branches: [main]

env:
  POSTGRES_DB: brain_tutor_db
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  DATABASE_HOST: db
  DATABASE_PORT: 5432
  REDIS_HOST: redis
  REDIS_PORT: 6379

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - name: üîç Checkout –∫–æ–¥
        uses: actions/checkout@v3

      - name: üê≥ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Compose CLI
        run: |
          DOCKER_CONFIG=$HOME/docker-config
          mkdir -p $DOCKER_CONFIG/cli-plugins
          curl -SL https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-linux-x86_64  -o $DOCKER_CONFIG/cli-plugins/docker-compose
          chmod +x $DOCKER_CONFIG/cli-plugins/docker-compose
          export PATH="$DOCKER_CONFIG/cli-plugins:$PATH"
          docker compose version

      - name: üì¶ –õ–æ–≥–∏–Ω –≤ Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üßπ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        run: |
          echo "–û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
          sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/* ~/.cache/pip || true
          sudo rm -rf /tmp/* ~/.cache/* ~/.docker/cache || true
          docker system prune -af || true
          df -h

      - name: üè∑ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–≥–∞ Docker
        id: docker_tag
        run: |
          RAW_TAG=$(if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then echo "latest"; else echo "${GITHUB_REF##refs/heads/}"; fi)
          SAFE_TAG=$(echo "$RAW_TAG" | tr '/' '-' | tr -cd 'a-zA-Z0-9_.-')
          echo "TAG=$SAFE_TAG" >> $GITHUB_ENV

      - name: üõ†Ô∏è –°–±–æ—Ä–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –∏–∑ docker-compose.yml
        run: |
          docker compose -f docker-compose.yml build --no-cache

      - name: üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∑–∞–ø—É—Å–∫–æ–º –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
        run: |
          # –ü–æ–¥–Ω–∏–º–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≤ —Ñ–æ–Ω–µ
          docker compose -f docker-compose.yml up -d

          # –ñ–¥–µ–º, –ø–æ–∫–∞ –ë–î —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–π (–º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
          echo "–û–∂–∏–¥–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ PostgreSQL..."
          timeout=30
          while ! docker exec $(docker compose ps -q db) pg_isready -U postgres; do
            sleep 1
            timeout=$((timeout - 1))
            if [ $timeout -le 0 ]; then
              echo "PostgreSQL –Ω–µ —Å—Ç–∞–ª –¥–æ—Å—Ç—É–ø–Ω—ã–º –≤ —Ç–µ—á–µ–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥"
              exit 1
            fi
          done
          docker compose exec -T web python manage.py migrate --noinput
          # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
          docker compose exec -T web python manage.py test

      - name: üöÄ –°–±–æ—Ä–∫–∞ –∏ –ø—É—à –æ–±—Ä–∞–∑–æ–≤ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ç–µ–≥–æ–º
        run: |
          docker compose -f docker-compose.yml push

      - name: üßº –ü–æ–ª–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–≤–∫–ª—é—á–∞—è db –∏ redis)
        if: always()
        run: |
          docker compose -f docker-compose.yml down -v --remove-orphans || true