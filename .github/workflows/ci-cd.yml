name: Django CI/CD with Docker Compose

on:
  push:
    branches: [main, dev/*]
  pull_request:
    branches: [main]

env:
  POSTGRES_DB: brain_tutor_db
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  DATABASE_HOST: db
  DATABASE_PORT: 5432
  REDIS_HOST: redis
  REDIS_PORT: 6379

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - name: ðŸ” Checkout ÐºÐ¾Ð´
        uses: actions/checkout@v3

      - name: ðŸ³ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: âš™ï¸ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker Compose CLI
        run: |
          DOCKER_CONFIG=$HOME/docker-config
          mkdir -p $DOCKER_CONFIG/cli-plugins
          curl -SL https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-linux-x86_64  -o $DOCKER_CONFIG/cli-plugins/docker-compose
          chmod +x $DOCKER_CONFIG/cli-plugins/docker-compose
          export PATH="$DOCKER_CONFIG/cli-plugins:$PATH"
          docker compose version

      - name: ðŸ“¦ Ð›Ð¾Ð³Ð¸Ð½ Ð² Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÐºÑÑˆÐ° Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
        run: |
          echo "ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
          sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/* ~/.cache/pip || true
          sudo rm -rf /tmp/* ~/.cache/* ~/.docker/cache || true
          docker system prune -af || true
          df -h

      - name: ðŸ· ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐ³Ð° Docker
        id: docker_tag
        run: |
          RAW_TAG=$(if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then echo "latest"; else echo "${GITHUB_REF##refs/heads/}"; fi)
          SAFE_TAG=$(echo "$RAW_TAG" | tr '/' '-' | tr -cd 'a-zA-Z0-9_.-')
          echo "TAG=$SAFE_TAG" >> $GITHUB_ENV

      - name: Create .env file
        run: |
          echo "POSTGRES_DB=brain_tutor_db" >> .env
          echo "POSTGRES_USER=postgres" >> .env
          echo "POSTGRES_PASSWORD=postgres" >> .env
          echo "DATABASE_HOST=db" >> .env
          echo "DATABASE_PORT=5432" >> .env
          echo "REDIS_HOST=redis" >> .env
          echo "REDIS_PORT=6379" >> .env
          echo "TAG=latest" >> .env


      - name: ðŸ› ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð²ÑÐµÑ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð² Ð¸Ð· docker-compose.yml
        run: |
          docker compose -f docker-compose.yml build --no-cache

      - name: ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼ Ð²ÑÐµÑ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
        run: |
          # ÐŸÐ¾Ð´Ð½Ð¸Ð¼Ð°ÐµÐ¼ Ð²ÑÐµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð² Ñ„Ð¾Ð½Ðµ
          docker compose -f docker-compose.yml up -d

          # Ð–Ð´ÐµÐ¼, Ð¿Ð¾ÐºÐ° Ð‘Ð” ÑÑ‚Ð°Ð½ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾Ð¹ (Ð¼Ð¾Ð¶Ð½Ð¾ ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ñ‚ÑŒ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚ Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸)
          echo "ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ PostgreSQL..."
          timeout=30
          while ! docker exec $(docker compose ps -q db) pg_isready -U postgres; do
            sleep 1
            timeout=$((timeout - 1))
            if [ $timeout -le 0 ]; then
              echo "PostgreSQL Ð½Ðµ ÑÑ‚Ð°Ð» Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ð¼ Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ 30 ÑÐµÐºÑƒÐ½Ð´"
              exit 1
            fi
          done
          docker compose exec -T web python manage.py migrate --noinput
          # Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð²
          docker compose exec -T web python manage.py test

      - name: ðŸš€ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð¿ÑƒÑˆ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼ Ñ‚ÐµÐ³Ð¾Ð¼
        run: |
          docker compose -f docker-compose.yml push

      - name: ðŸ¤ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ Ð¿Ð¾ SSH (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ Ð¸Ð· Docker Hub)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "$SSH_PRIVATE_KEY" > key.pem
          chmod 600 key.pem
          ssh -o StrictHostKeyChecking=no -i key.pem -p 4444 $SSH_USER@37.193.252.134 << 'EOF'
            set -e
            cd ~/workspace/BrainRot

            echo "ðŸ§¹ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ñ‚ÐµÐºÑƒÑ‰Ð¸Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²"
            docker compose down

            echo "ðŸ“¦ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð²Ñ‹Ñ… Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² Ð¸Ð· Docker Hub"
            docker compose pull

            echo "ðŸš€ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð² Ñ„Ð¾Ð½Ðµ"
            docker compose up -d

            echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½"
          EOF
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}

      - name: ðŸ§¼ ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð²ÑÐµÑ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² (Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ db Ð¸ redis)
        if: always()
        run: |
          docker compose -f docker-compose.yml down -v --remove-orphans || true
